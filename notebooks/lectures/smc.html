<!DOCTYPE html>
<html><head><meta charset="UTF-8"><meta content="width=device-width, initial-scale=1" name="viewport"><meta content="In the last portion of the course, we looked at handling models with complex state spaces using MCMC. Now we turn to another approach to models with complex state spaces: sequential monte carlo (SMC). In MCMC we sample from our target distribution by iteratively adjusting subparts of our joint state. In SMC, we instead assume that the random variables in our joint distribution states are ordered and we sample them sequentially with later samples conditioned on the earlier samples. SMC techniques were originally developed for time series data and it is most natural to explain them in this setting. However, it should be kept in mind that we are free to impose an ordering on the random variables in any model and thus SMC can be used as an alternative to MCMC (or in combination with MCMC) for sampling from distributions with complex joint states." property="og:description"><meta property="og:title"><meta content="article:clerk" property="og:type"><meta content="summary_large_image" name="twitter:card"><script src="https://cdn.tailwindcss.com?plugins=typography" type="text/javascript"></script><script>tailwind.config = {
  darkMode: "class",
  content: ["./tw/viewer.js", "./tw/**/*.edn"],
  safelist: ['dark'],
  theme: {
    extend: {},
    fontFamily: {
      sans: ["Fira Sans", "-apple-system", "BlinkMacSystemFont", "sans-serif"],
      serif: ["PT Serif", "serif"],
      mono: ["Fira Mono", "monospace"]
    }
  },
  variants: {
    extend: {},
  },
  plugins: [],
}
</script><style type="text/tailwindcss">@tailwind base;
@tailwind components;
@tailwind utilities;

@layer base {
  html {
    font-size: 18px;
  }
  @media (max-width: 600px) {
    html {
      font-size: 16px;
    }
  }
  .font-condensed { font-family: "Fira Sans Condensed", sans-serif; }
  .font-inter     { font-family: "Inter", sans-serif; }
  body {
    @apply font-serif antialiased text-gray-900 sm:overscroll-y-none;
  }
  code, .code {
    @apply font-mono text-sm text-gray-900 bg-slate-50 px-0.5 py-px rounded dark:bg-gray-800;
  }
  code::before, code::after { @apply content-none !important; }
  h1, h3, h4, h5, h6 {
    @apply font-condensed font-bold mt-8 first:mt-0;
  }
  h2 {
    /*We cannot collapse margins due to nesting but we want to*/
    /*keep the h2’s large margin visible*/
    @apply font-condensed font-bold mt-8 first:mt-2;
  }
  h1 { @apply text-4xl; }
  h2 { @apply text-3xl; }
  h3 { @apply text-2xl; }

  @media print {
      h1 { @apply text-2xl !important; }
      h2 { @apply text-xl !important; }
      h3 { @apply text-lg !important; }
  }

  button { @apply focus:outline-none; }
  strong { @apply font-bold; }
  em     { @apply italic; }
  pre    { @apply m-0 font-mono; }
  table img { @apply inline-block; }
}

/* Compatibility */
/* --------------------------------------------------------------- */
/* TODO: Verify which colors are in use and replace with Tailwind
   colors accordingly. Move Nj-specific styles out of here. */

:root {
  --teal-color: #31afd0;
  --dark-teal-color: #095960;
  --near-black-color: #2e2e2c;
  --red-color: #d64242;
  --dark-blue-color: #1f2937;
  --dark-blue-60-color: rgba(28, 42, 56, 0.6);
  --gray-panel-color: rgba(239, 241, 245, 1.000);
  --brand-color: var(--dark-blue-color);
  --link-color: #5046e4;
  --command-bar-selected-color: var(--teal-color);
}

.serif      { @apply font-serif; }
.sans-serif { @apply font-sans; }
.monospace  { @apply font-mono; }
.inter      { @apply font-inter; }

.border-color-teal { border-color: var(--dark-teal-color); }
.teal { color: var(--teal-color); }
.bg-dark-blue { background: var(--dark-blue-color); }
.bg-dark-blue-60 { background: rgba(28, 42, 56, 0.6); }
.bg-gray-panel { background: var(--gray-panel-color); }
.text-dark-blue  { color: var(--dark-blue-color); }
.text-dark-blue-60 { color: var(--dark-blue-60-color); }
.border-dark-blue-30 { border-color: rgba(28, 42, 56, 0.6); }
.text-brand { color: var(--dark-blue-color); }
.bg-brand { background: var(--dark-blue-color); }
.text-selected { color: white; }
.red { color: var(--red-color); }

/* Disclose Button */
/* --------------------------------------------------------------- */

.disclose {
  @apply content-none border-solid cursor-pointer inline-block relative mr-[3px] top-[-2px] transition-all;
  border-color: var(--near-black-color) transparent;
  border-width: 6px 4px 0;
}
.disclose:hover {
  border-color: var(--near-black-color) transparent;
}
.dark .disclose,
.dark .disclose:hover {
  border-color: white transparent;
}
.disclose.collapsed {
  @apply rotate-[-90deg];
}

/* Layout */
/* --------------------------------------------------------------- */

.page {
  @apply max-w-5xl mx-auto px-12 box-border flex-shrink-0;
}
.max-w-prose { @apply max-w-[46rem] !important; }
.max-w-wide  { @apply max-w-3xl !important; }

/* List Styles */
/* --------------------------------------------------------------- */

.task-list-item + .task-list-item,
.markdown-viewer ul ul {
  @apply mt-1 mb-0;
}

/* compact TOC */
.markdown-viewer .toc ul {
  list-style: none;
  @apply my-1;
}

/* Code Viewer */
/* --------------------------------------------------------------- */

.code-viewer {
  @apply font-mono bg-slate-100 rounded-sm text-sm overflow-x-auto dark:bg-gray-800;
}
.code-listing  {
    @apply -ml-8 -mr-8 relative !important;
}
.code-viewer .cm-content {
  @apply py-4 px-8;
}
@media (min-width: 960px){
    .notebook-viewer .code-viewer .cm-content {
        @apply pl-12;
    }
    .notebook-viewer .code-listing {
        width: 48rem !important;
        @apply -ml-12 mr-0 !important;
    }
}
/* Don’t show focus outline when double-clicking cell in Safari */
.cm-scroller { @apply focus:outline-none; }

/* Syntax Highlighting */
/* --------------------------------------------------------------- */

.inspected-value { @apply text-xs font-mono leading-[1.25rem]; }
.cmt-strong, .cmt-heading { @apply font-bold; }
.cmt-italic, .cmt-emphasis { @apply italic; }
.cmt-strikethrough { @apply line-through; }
.cmt-link { @apply underline; }
.untyped-value { @apply whitespace-nowrap; }

.cm-editor, .cmt-default, .result-viewer {
  @apply text-slate-800 dark:text-slate-300;
}
.cmt-keyword {
  @apply text-purple-800 dark:text-pink-400;
}
.cmt-atom, .cmt-bool, .cmt-url, .cmt-contentSeparator, .cmt-labelName {
  @apply text-blue-900 dark:text-blue-300;
}
.cmt-inserted, .cmt-literal {
  @apply text-emerald-700 dark:text-emerald-200;
}
.cmt-string, .cmt-deleted {
  @apply text-rose-700 dark:text-sky-300;
}
.cmt-italic.cmt-string {
  @apply dark:text-sky-200;
}
.cmt-regexp, .cmt-escape {
  @apply text-orange-500 dark:text-orange-300;
}
.cmt-variableName {
  @apply text-blue-800 dark:text-sky-300;
}
.cmt-typeName, .cmt-namespace {
  @apply text-emerald-600 dark:text-emerald-300;
}
.cmt-className {
  @apply text-teal-600 dark:text-teal-200;
}
.cmt-macroName {
  @apply text-teal-700 dark:text-teal-200;
}
.cmt-propertyName {
  @apply text-blue-700 dark:text-blue-200;
}
.cmt-comment {
  @apply text-slate-500 dark:text-slate-400;
}
.cmt-meta {
  @apply text-slate-600 dark:text-slate-400;
}
.cmt-invalid {
  @apply text-red-500 dark:text-red-300;
}

.result-data {
  @apply font-mono text-sm overflow-x-auto whitespace-nowrap leading-normal;
}
.result-data::-webkit-scrollbar, .path-nav::-webkit-scrollbar {
  @apply h-0;
}
.result-data-collapsed {
  @apply whitespace-nowrap;
}
.result-data-field {
  @apply ml-4 whitespace-nowrap;
}
.result-data-field-link{
  @apply ml-4 whitespace-nowrap cursor-pointer;
}
.result-data-field-link:hover {
  @apply text-black bg-black/5;
}
.result-text-empty {
  color: rgba(0,0,0,.3);
}
.browsify-button:hover {
  box-shadow: -2px 0 0 2px #edf2f7;
}

/* Prose */
/* --------------------------------------------------------------- */

.notebook-viewer,
.markdown-viewer {
  @apply prose
    dark:prose-invert
    prose-a:text-blue-600 prose-a:no-underline hover:prose-a:underline
    dark:prose-a:text-blue-300
    prose-p:mt-4 prose-p:leading-snug
    prose-ol:mt-4 prose-ol:mb-6 prose-ol:leading-snug
    prose-ul:mt-4 prose-ul:mb-6 prose-ul:leading-snug
    prose-blockquote:mt-4 prose-blockquote:leading-snug
    prose-hr:mt-6 prose-hr:border-t-2 prose-hr:border-solid prose-hr:border-slate-200
    prose-figure:mt-4
    prose-figcaption:mt-2 prose-figcaption:text-xs
    prose-headings:mb-4
    prose-table:mt-0
    prose-th:mb-0
    prose-img:my-0
    prose-code:font-medium prose-code:bg-slate-100
    max-w-none;
}
.markdown-viewer blockquote p:first-of-type:before,
.markdown-viewer blockquote p:last-of-type:after {
  @apply content-none;
}
.markdown-node-viewer.result-viewer.fragment-item {
    @apply mb-0 !important;
}

/* Images */
/* --------------------------------------------------------------- */


/* Todo Lists */
/* --------------------------------------------------------------- */

.contains-task-list {
  @apply pl-6 list-none;
}
.contains-task-list input[type="checkbox"] {
  @apply appearance-none h-4 w-4 rounded border border-slate-200 relative mr-[0.3rem] ml-[-1.5rem] top-[0.15rem];
}
.contains-task-list input[type="checkbox"]:checked {
  @apply border-indigo-600 bg-indigo-600 bg-no-repeat bg-contain;
  background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
}

/* Markdown TOC */
/* --------------------------------------------------------------- */

.markdown-viewer .toc      { @apply mt-4; }
.markdown-viewer h1 + .toc { @apply mt-8; }

.markdown-viewer .toc h1,
.markdown-viewer .toc h2,
.markdown-viewer .toc h3,
.markdown-viewer .toc h4,
.markdown-viewer .toc h5,
.markdown-viewer .toc h6 {
  @apply text-base text-indigo-600 font-sans my-0;
}
.markdown-viewer .toc a {
  @apply text-indigo-600 font-normal no-underline hover:underline;
}
.markdown-viewer .toc li    { @apply m-0; }
.markdown-viewer .toc ul ul { @apply pl-4; }

/* Notebook Spacing */
/* --------------------------------------------------------------- */

.markdown-viewer *:first-child:not(.code-viewer):not(li):not(h2):not(.sidenote) { @apply mt-0; }
/*.viewer + .viewer { @apply mt-6; }*/
.viewer + .result-viewer { @apply mt-0; }
.code-viewer + .result-viewer { @apply mt-3; }
.markdown-viewer + .markdown-viewer { @apply mt-0; }

/* Sidenotes */
/* --------------------------------------------------------------- */

.sidenote-ref {
  @apply top-[-0.5em] w-auto h-auto inline border-0 bg-transparent m-0 pointer-events-none;
}
.sidenote {
  @apply block font-sans text-xs mt-4 bg-slate-100 dark:bg-slate-800 p-4;
  font-style: normal;
  font-weight: normal;
}
.sidenote-container {
  @apply mb-4;
}
@media (min-width: 860px) {
  .sidenote sup { @apply inline; }
  .sidenote-column {
    @apply w-[165px] absolute right-0 top-0 -mr-[205px];
  }
  .sidenote {
    @apply bg-transparent dark:bg-transparent p-0;
  }
  .sidenote:first-child {
    @apply mt-1;
  }
  .sidenotes-layout .markdown-viewer {
    @apply pr-[241px];
  }
  .sidenote-container {
    @apply relative mb-0;
  }
  .sidenotes-layout h1 {
    @apply w-[756px] !important;
  }
}
.code-viewer + .viewer:not(.code-viewer):not(.code-viewer-folded),
.code-viewer-folded + .viewer:not(.code-viewer):not(.code-viewer-folded),
.result-viewer:not(.markdown-node-viewer) + .result-viewer {
  @apply mt-2;
}
.code-viewer + .code-viewer-folded {
  @apply mt-4;
}
.result-viewer {
  @apply leading-tight mb-6;
}
.code-viewer.fragment-item.result-viewer {
  @apply mb-0 !important;
}
.result-viewer figure {
  @apply mt-0 !important;
}
@media (min-width: 768px) {
  .devcard-desc > div {
    @apply max-w-full m-0;
  }
}

/* Command Palette */
/* --------------------------------------------------------------- */

.nj-commands-input {
  @apply bg-transparent text-white;
}
.nj-context-menu-item:hover:not([disabled]) {
  @apply cursor-pointer;
  background-color: rgba(255,255,255,.14);
}

/* Devdocs */
/* --------------------------------------------------------------- */

.logo, .logo-white {
  @apply block indent-[-999em];
  background: url(/images/nextjournal-logo.svg) center center no-repeat;
}
.devdocs-body {
  @apply font-inter;
}

/* Workarounds */
/* --------------------------------------------------------------- */

/* Fixes vega viewer resizing into infinity */
.vega-embed .chart-wrapper { @apply h-auto !important; }
/* fixes fraction separators being overridden by tw’s border-color */
.katex * { @apply border-black; }

@media print {
    .dark-mode-toggle,
    .toc-toggle { @apply hidden; }
    .notebook-viewer { @apply pt-0; font-size: 12pt !important; margin-left: 0 !important; }
    .code-viewer .cm-content,
    .viewer-code .cm-content { @apply whitespace-pre-wrap !important; overflow: none; }
    .code-viewer .cm-line { font-size: 12pt !important; }
    html * { page-break-inside: avoid !important; }
    .toc-panel { @apply hidden; }
}
</style><script src="https://cas.clerk.garden/tree/8VxCcd2nQqrhPLVttyyM5Rnv8qMYcjeSEjgJnhZTvCgVhmgsNWWeusxmVkfX9ajrXmFqQEdVmtdHSoCdHLG2XTsXXB/.clerk/shadow-cljs/main.js" type="module"></script><link href="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.css" rel="stylesheet" type="text/css"><link href="https://fonts.bunny.net" rel="preconnect"><link href="https://fonts.bunny.net/css?family=fira-mono:400,700%7Cfira-sans:400,400i,500,500i,700,700i%7Cfira-sans-condensed:700,700i%7Cpt-serif:400,400i,700,700i" rel="stylesheet" type="text/css"></head><body class="dark:bg-gray-900"><div id="clerk"></div><script type="module">let viewer = nextjournal.clerk.sci_env
let state = "{:bundle? false, :path->doc {\"notebooks/lectures/smc.clj\" {:path [], :nextjournal/value {:toc [], :sidenotes? false, :atom-var-name->state #viewer-eval (nextjournal.clerk.render/intern-atoms! {}), :ns #viewer-eval (ns user), :file \"notebooks/lectures/smc.clj\", :bundle? false, :header {:path [], :nextjournal/value [:div.viewer.w-full.max-w-prose.px-8.not-prose.mt-3 [:div.mb-8.text-xs.sans-serif.text-slate-400 nil [:<> [:a.font-medium.border-b.border-dotted.border-slate-300.hover:text-indigo-500.hover:border-indigo-500.dark:border-slate-500.dark:hover:text-white.dark:hover:border-white.transition {:href \"./../../\"} \"Index\"] [:span.mx-2 \"•\"]] [:span \"Generated with \" [:a.font-medium.border-b.border-dotted.border-slate-300.hover:text-indigo-500.hover:border-indigo-500.dark:border-slate-500.dark:hover:text-white.dark:hover:border-white.transition {:href \"https://clerk.vision\"} \"Clerk\"] \" from \" [:a.font-medium.border-b.border-dotted.border-slate-300.hover:text-indigo-500.hover:border-indigo-500.dark:border-slate-500.dark:hover:text-white.dark:hover:border-white.transition {:href \"https://github.com/sritchie/tim-class/blob/573ebd011b9e427199a1f35ba3858ca43f9b7243/notebooks/lectures/smc.clj\"} \"notebooks/lectures/smc.clj\" [:<> \"@\" [:span.tabular-nums \"573ebd0\"]]]]]], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}, :open-graph {:type \"article:clerk\", :title nil, :description \"In the last portion of the course, we looked at handling models with complex state spaces using MCMC. Now we turn to another approach to models with complex state spaces: sequential monte carlo (SMC). In MCMC we sample from our target distribution by iteratively adjusting subparts of our joint state. In SMC, we instead assume that the random variables in our joint distribution states are ordered and we sample them sequentially with later samples conditioned on the earlier samples. SMC techniques were originally developed for time series data and it is most natural to explain them in this setting. However, it should be kept in mind that we are free to impose an ordering on the random variables in any model and thus SMC can be used as an alternative to MCMC (or in combination with MCMC) for sampling from distributions with complex joint states.\"}, :blocks [{:path [], :nextjournal/value [:div.viewer.markdown-viewer.w-full.max-w-prose.px-8 {:data-block-id \"user/markdown-5dtpsQfikDADatdBt6QzAGCpBctowm\"} [:p [:<> \"In the last portion of the course, we looked at handling models with complex\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"state spaces using MCMC. Now we turn to another approach to models with\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"complex state spaces: \"] [:em [:<> \"sequential monte carlo\"]] [:<> \" (SMC). In MCMC we sample from\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"our target distribution by iteratively adjusting subparts of our joint state.\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"In SMC, we instead assume that the random variables in our joint distribution\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"states are \"] [:strong [:<> \"ordered\"]] [:<> \" and we sample them sequentially with later samples\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"conditioned on the earlier samples. SMC techniques were originally developed\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"for time series data and it is most natural to explain them in this setting.\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"However, it should be kept in mind that we are free to impose an ordering on\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"the random variables in any model and thus SMC can be used as an alternative\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"to MCMC (or in combination with MCMC) for sampling from distributions with\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"complex joint states.\"]] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:div.code-viewer.code-listing [#viewer-eval nextjournal.clerk.render/inspect-presented {:path [0], :nextjournal/value \"using Gen\\nusing Distributions\\nusing Plots\\nusing Printf\\n\\nimport Logging; Logging.disable_logging(Logging.Info) # Disable info messages when making gif\", :nextjournal/render-opts {:language \"julia\"}, :nextjournal/viewer {:name nextjournal.clerk.viewer/code-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-code, :hash \"5dsJQw12yyyd7TcZEf52VSHxnqnJUC\"}}]], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:p [:<> \"To introduce SMC, we will use the Hidden Markov model as our running example.\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"Unlike the defition we used earlier in the course, however, we will fix our\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"initial, transition, and observation distributions.\"]] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:div.code-viewer.code-listing [#viewer-eval nextjournal.clerk.render/inspect-presented {:path [0], :nextjournal/value \"T=100\\nK=50\\nO=10\\n\\nδ = fill(10.0,K)\\nα = fill(10.0,K)\\nϵ = fill(0.1,O)\\n\\n;; initial distribution over latent states\\nϕ = rand(Dirichlet(δ))\\n\\ntransition = zeros(K,K)\\nfor k in 1:K\\n    transition[k,:] = rand(Dirichlet(α))\\nend\\n\\nobservation = zeros(K,O)\\nfor k in 1:K\\n    observation[k,:] =  rand(Dirichlet(ϵ))\\nend\\n\\n@gen function hmm(T, ϕ, transition, observation)\\n\\n    xs=Vector{Int}(undef, T)\\n    zs=Vector{Int}(undef, T)\\n\\n    zs[1] = {:z => 1} ~ categorical(ϕ)\\n    xs[1] = {:x => 1} ~ categorical(observation[zs[1],:])\\n\\n    for t in 2:T\\n        zs[t] = {:z => t} ~ categorical(transition[zs[t-1],:])\\n        xs[t] = {:x => t} ~ categorical(observation[zs[t],:])\\n    end\\n    return(xs)\\nend\\n\\nground_truth=Gen.simulate(hmm, (T, ϕ, transition, observation));\\nget_choices(ground_truth)\", :nextjournal/render-opts {:language \"julia\"}, :nextjournal/viewer {:name nextjournal.clerk.viewer/code-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-code, :hash \"5dsJQw12yyyd7TcZEf52VSHxnqnJUC\"}}]], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:p [:<> \"Similar to our study of the GMM model in the unit on MCMC, we will focus on\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"the posterior distribution over our state-assigment variables \"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value \"z_t\", :nextjournal/viewer {:name :nextjournal.markdown/formula, :render-fn #viewer-fn (fn [tex] (nextjournal.clerk.render/render-katex tex {:inline? true})), :hash \"5dt6DiPBjaZbeXfXmhPfzC4UAAhKDu\"}}] [:<> \".\"]] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value \"p(z_{1:t} | x_{1:t}, \\\\phi, A, E)\", :nextjournal/viewer {:name :nextjournal.markdown/block-formula, :render-fn #viewer-fn nextjournal.clerk.render/render-katex, :hash \"5dtLYB93Mi3NowoYurf1Ue76yrXtDC\"}}] [:p [:<> \"To simplify the notation, let's suppress the hyperparameters and use the\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"probability mass function \"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value \"p\", :nextjournal/viewer {:name :nextjournal.markdown/formula, :render-fn #viewer-fn (fn [tex] (nextjournal.clerk.render/render-katex tex {:inline? true})), :hash \"5dt6DiPBjaZbeXfXmhPfzC4UAAhKDu\"}}] [:<> \" to refer to this distribution.\"]] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value \"p(z_{1:t} | x_{1:t})\", :nextjournal/viewer {:name :nextjournal.markdown/block-formula, :render-fn #viewer-fn nextjournal.clerk.render/render-katex, :hash \"5dtLYB93Mi3NowoYurf1Ue76yrXtDC\"}}] [:p [:<> \"Our joint distribution is given by the following expression.\"]] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value \"p(z_{1:t}, x_{1:t}) = \\\\phi(z_1)p(x_1 \\\\mid z_1)\\\\prod_{s=2}^t p(z_s \\\\mid z_{s-1})p(x_s \\\\mid z_{s})\", :nextjournal/viewer {:name :nextjournal.markdown/block-formula, :render-fn #viewer-fn nextjournal.clerk.render/render-katex, :hash \"5dtLYB93Mi3NowoYurf1Ue76yrXtDC\"}}] [:p [:<> \"This joint posterior is defined using conditioning as\"]] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value \"\\\\begin{align}\\n p(z_{1:t} | x_{1:t}) &= \\\\frac{p(z_{1:t}, x_{1:t})}{p(x_{1:t})}\\\\\\\\\\n p(z_{1:t} | x_{1:t})&= \\\\frac{p(z_{1:t}, x_{1:t})}{ \\\\sum_{z_{1:t}} p(z_{1:t}, x_{1:t})}\\\\\\\\\\n p(z_{1:t} | x_{1:t})&=\\\\frac{\\\\phi(z_1)p(x_1 \\\\mid z_1)\\\\prod_{s=2}^t p(z_s \\\\mid z_{s-1})p(x_s \\\\mid z_{s})}{\\\\sum_{z_{1:t}} \\\\phi(z_1)p(x_1 \\\\mid z_1)\\\\prod_{s=2}^t p(z_s \\\\mid z_{s-1})p(x_s \\\\mid z_{s})}\\\\end{align}\", :nextjournal/viewer {:name :nextjournal.markdown/block-formula, :render-fn #viewer-fn nextjournal.clerk.render/render-katex, :hash \"5dtLYB93Mi3NowoYurf1Ue76yrXtDC\"}}] [:p [:<> \"In the case of the HMM model, the marginal on the bottom of this fraction can\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"be computed efficiently using dynamic programming (using so-called forward\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"algorithm); alternatively, we can also define a Gibbs sampler that samples\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"from the conditional posterior distributions $p(z_{i} | z_{1:(i-1)},\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"z_{(i+1):t}, x_{1:t})$.\"]] [:p [:<> \"However, in this unit we will take a different approach: \"] [:em [:<> \"Sequential Monte\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"Carlo\"]] [:<> \".\"]] [\"h1\" {:id \"sequential-monte-carlo:-sequentializing-the-hmm-posterior\"} [:<> \"Sequential Monte Carlo: Sequentializing the HMM Posterior\"]] [:p [:<> \"The idea behind SMC is that we would like to update our model sequentially\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"incoporating sampling the \"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value \"z_i\", :nextjournal/viewer {:name :nextjournal.markdown/formula, :render-fn #viewer-fn (fn [tex] (nextjournal.clerk.render/render-katex tex {:inline? true})), :hash \"5dt6DiPBjaZbeXfXmhPfzC4UAAhKDu\"}}] [:<> \" in order \"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value \"1 \\\\dots t\", :nextjournal/viewer {:name :nextjournal.markdown/formula, :render-fn #viewer-fn (fn [tex] (nextjournal.clerk.render/render-katex tex {:inline? true})), :hash \"5dt6DiPBjaZbeXfXmhPfzC4UAAhKDu\"}}] [:<> \", and incorporating the\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"previous samples as well as the data \"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value \"x_{1:t}\", :nextjournal/viewer {:name :nextjournal.markdown/formula, :render-fn #viewer-fn (fn [tex] (nextjournal.clerk.render/render-katex tex {:inline? true})), :hash \"5dt6DiPBjaZbeXfXmhPfzC4UAAhKDu\"}}] [:<> \" into the distribution that we\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"use for subsequent \"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value \"z_i\", :nextjournal/viewer {:name :nextjournal.markdown/formula, :render-fn #viewer-fn (fn [tex] (nextjournal.clerk.render/render-katex tex {:inline? true})), :hash \"5dt6DiPBjaZbeXfXmhPfzC4UAAhKDu\"}}] [:<> \"'s.\"]] [:p [:<> \"This suggests that we might use the chain rule decomposition of the posterior\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"to derive a sequence of conditional distributions over states which can be\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"sampled one at a time, in order.\"]] [:p [:<> \"Consider our posteriori distribution \"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value \"p(z_{1:t} | x_{1:t})\", :nextjournal/viewer {:name :nextjournal.markdown/formula, :render-fn #viewer-fn (fn [tex] (nextjournal.clerk.render/render-katex tex {:inline? true})), :hash \"5dt6DiPBjaZbeXfXmhPfzC4UAAhKDu\"}}] [:<> \". Using the chain\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"rule, we can rewrite this into a sequence of conditional distributions:\"]] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value \" \\\\begin{align}p(z_{1:t} | x_{1:t}) &= p(z_{1} | x_{1:t})p(z_{2} | z_{1}, x_{1:t})p(z_{3} | z_{1:2}, x_{1:t})\\\\dots p(z_{t} | z_{1:(t-1)}, x_{1:t}) \\\\\\\\\\n  &= p(z_1 \\\\mid x_{1:t})\\\\prod_{s=2}^t p(z_s \\\\mid z_{1:(s-1)}, x_{1:t}) \\\\end{align}\", :nextjournal/viewer {:name :nextjournal.markdown/block-formula, :render-fn #viewer-fn nextjournal.clerk.render/render-katex, :hash \"5dtLYB93Mi3NowoYurf1Ue76yrXtDC\"}}] [:p [:<> \"The first conditional, \"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value \"p(z_1 \\\\mid x_{1:t})\", :nextjournal/viewer {:name :nextjournal.markdown/formula, :render-fn #viewer-fn (fn [tex] (nextjournal.clerk.render/render-katex tex {:inline? true})), :hash \"5dt6DiPBjaZbeXfXmhPfzC4UAAhKDu\"}}] [:<> \" can be computed using Bayes'\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"rule\"]] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value \"\\\\begin{align}p(z_1 \\\\mid x_{1:t})\\n &= \\\\frac{ p(z_1, x_{1:t})}{\\\\sum_{z^\\\\prime_1} p(z^\\\\prime_1, x_{1:t})}\\\\\\\\\\n &= \\\\frac{ \\\\sum_{z_{2:t}} p(z_1, x_1, z_{2:t}, x_{2:t})}{\\\\sum_{z^\\\\prime_1} \\\\sum_{z^\\\\prime_{2:t}} p(z^\\\\prime_1, x_1, z^\\\\prime_{2:t}, x_{2:t})}\\\\\\\\\\n &= \\\\frac{\\\\sum_{z_{2:t}} \\\\phi(z_1)p(x_{1}\\\\mid z_1) \\\\prod_{s=2}^t p(z_{s} \\\\mid z_{s-1}) p(x_{s} \\\\mid z_{s})}{\\\\sum_{z^\\\\prime_1} \\\\sum_{z^\\\\prime_{2:t}} \\\\phi(z_1)p(x_{1}\\\\mid z^\\\\prime_1) \\\\prod_{s=2}^t p(z^\\\\prime_{s} \\\\mid z^\\\\prime_{s-1}) p(x_{s} \\\\mid z^\\\\prime_{s})}\\\\\\\\\\n &= \\\\frac{ \\\\phi(z_1)p(x_{1}\\\\mid z_1) \\\\sum_{z_{2:t}} \\\\prod_{s=2}^t p(z_{s} \\\\mid z_{s-1}) p(x_{s} \\\\mid z_{s})}{\\\\sum_{z^\\\\prime_1}  \\\\phi(z_1)p(x_{1}\\\\mid z^\\\\prime_1) \\\\sum_{z^\\\\prime_{2:t}}\\\\prod_{s=2}^t p(z^\\\\prime_{s} \\\\mid z^\\\\prime_{s-1}) p(x_{s} \\\\mid z^\\\\prime_{s})}\\\\\\\\\\n &= \\\\frac{ \\\\phi(z_1)p(x_{1}\\\\mid z_1) \\\\sum_{z_{2:t}} p(z_{2:t}, x_{2:t} \\\\mid z_1)}{\\n \\\\sum_{z^\\\\prime_1}  \\\\phi(z^\\\\prime_1)p(x_{1}\\\\mid z^\\\\prime_1) \\\\sum_{z^\\\\prime_{2:t}}  p(z^\\\\prime_{2:t}, x_{2:t} \\\\mid z^\\\\prime_1)}\\\\\\\\\\n &= \\\\frac{ \\\\phi(z_1)p(x_{1}\\\\mid z_1)  p(x_{2:t} \\\\mid z_1)}{\\n \\\\sum_{z^\\\\prime_1}  \\\\phi(z^\\\\prime_1)p(x_{1}\\\\mid z^\\\\prime_1)  p(x_{2:t} \\\\mid z^\\\\prime_1)}\\\\\\\\\\n \\\\end{align}\", :nextjournal/viewer {:name :nextjournal.markdown/block-formula, :render-fn #viewer-fn nextjournal.clerk.render/render-katex, :hash \"5dtLYB93Mi3NowoYurf1Ue76yrXtDC\"}}] [:p [:<> \"Subsequent conditionals can also be computed in a similar way. Assuming that\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value \"z_{s-1}\", :nextjournal/viewer {:name :nextjournal.markdown/formula, :render-fn #viewer-fn (fn [tex] (nextjournal.clerk.render/render-katex tex {:inline? true})), :hash \"5dt6DiPBjaZbeXfXmhPfzC4UAAhKDu\"}}] [:<> \" is distributed according to its true posterior, we can recursively\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"sample\"]] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value \" \\\\begin{align}p(z_s \\\\mid z_{1:(s-1)}, x_{1:t})\\n &= \\\\frac{\\\\phi(z_1)p(x_1 \\\\mid z_1)\\\\prod_{i=2}^{(s-1)} p(z_i \\\\mid z_{i-1})p(x_i \\\\mid z_{i})\\\\times\\\\quad~~ p(z_s \\\\mid z_{(s-1)})p(x_s \\\\mid z_{s}) \\\\sum_{z_{(s+1):t}}p(z_{(s+1):t}, x_{(s+1):t} \\\\mid z_{s})}\\n         {\\\\phi(z_1)p(x_1 \\\\mid z_1)\\\\prod_{i=2}^{(s-1)} p(z_i \\\\mid z_{i-1})p(x_i \\\\mid z_{i})\\\\times \\\\sum_{z^\\\\prime_s} p(z^\\\\prime_s \\\\mid z_{(s-1)})p(x_s \\\\mid z^\\\\prime_{s})\\\\sum_{z^\\\\prime_{(s+1):t}}p(z^\\\\prime_{(s+1):t}, x_{(s+1):t} \\\\mid z^\\\\prime_s)}\\\\\\\\\\n  &= \\\\frac{p(z_s \\\\mid z_{(s-1)})p(x_s \\\\mid z_{s})\\\\sum_{z_{(s+1):t}}p(z_{(s+1):t}, x_{(s+1):t} \\\\mid z_s)}\\n         { \\\\sum_{z^\\\\prime_s} p(z^\\\\prime_s \\\\mid z_{(s-1)})p(x_s \\\\mid z^\\\\prime_{s})\\\\sum_{z^\\\\prime_{(s+1):t}}p(z^\\\\prime_{(s+1):t}, x_{(s+1):t} \\\\mid z^\\\\prime_s)}\\\\\\\\\\n &= \\\\frac{p(z_s \\\\mid z_{s-1})p(x_s \\\\mid z_{s})p(x_{(s+1):t} \\\\mid z_s)}\\n         { \\\\sum_{z^\\\\prime_s} p(z^\\\\prime_s \\\\mid z_{s-1})p(x_s \\\\mid z^\\\\prime_{s})p(x_{(s+1):t} \\\\mid z^\\\\prime_s) }\\\\\\\\\\n      &= p(z_s \\\\mid z_{s-1}, x_{s:t})\\n \\\\end{align}\", :nextjournal/viewer {:name :nextjournal.markdown/block-formula, :render-fn #viewer-fn nextjournal.clerk.render/render-katex, :hash \"5dtLYB93Mi3NowoYurf1Ue76yrXtDC\"}}] [:p [:<> \"The last line shows that in fact, if we know the state at the preceding time\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"step \"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value \"z_{s-1}\", :nextjournal/viewer {:name :nextjournal.markdown/formula, :render-fn #viewer-fn (fn [tex] (nextjournal.clerk.render/render-katex tex {:inline? true})), :hash \"5dt6DiPBjaZbeXfXmhPfzC4UAAhKDu\"}}] [:<> \", then we can forget the rest of the past. This simplifies our\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"chain rule decomposition somewhat.\"]] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value \" \\\\begin{align}p(z_{1:t} | x_{1:t}) &= p(z_{1} | x_{1:t})p(z_{2} | z_{1}, x_{2:t})p(z_{3} | z_{2}, x_{3:t})\\\\dots p(z_{t} | z_{t-1}, x_{t}) \\\\\\\\\\n  &= p(z_1 \\\\mid x_{1:t})\\\\prod_{s=2}^t p(z_s \\\\mid z_{s-1}, x_{s:t}) \\\\end{align}\", :nextjournal/viewer {:name :nextjournal.markdown/block-formula, :render-fn #viewer-fn nextjournal.clerk.render/render-katex, :hash \"5dtLYB93Mi3NowoYurf1Ue76yrXtDC\"}}] [:p [:<> \"To use this sequence of distributions as a sampler, we could draw samples for\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"each \"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value \"z_s\", :nextjournal/viewer {:name :nextjournal.markdown/formula, :render-fn #viewer-fn (fn [tex] (nextjournal.clerk.render/render-katex tex {:inline? true})), :hash \"5dt6DiPBjaZbeXfXmhPfzC4UAAhKDu\"}}] [:<> \" in order, starting from the first distribution and moving forward.\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"Once we reach the end of our observed sequence, we will have drawn a sample\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"from our target posterior: \"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value \"p(z_{1:t} | x_{1:t})\", :nextjournal/viewer {:name :nextjournal.markdown/formula, :render-fn #viewer-fn (fn [tex] (nextjournal.clerk.render/render-katex tex {:inline? true})), :hash \"5dt6DiPBjaZbeXfXmhPfzC4UAAhKDu\"}}] [:<> \".\"]] [:p [:<> \"However, to compute this sequence of exact componenent-wise posterior\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"distributions over each state \"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value \"z_s\", :nextjournal/viewer {:name :nextjournal.markdown/formula, :render-fn #viewer-fn (fn [tex] (nextjournal.clerk.render/render-katex tex {:inline? true})), :hash \"5dt6DiPBjaZbeXfXmhPfzC4UAAhKDu\"}}] [:<> \", we have to be able to efficient compute\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value \"p(x_{(s+1):t} \\\\mid z_s)\", :nextjournal/viewer {:name :nextjournal.markdown/formula, :render-fn #viewer-fn (fn [tex] (nextjournal.clerk.render/render-katex tex {:inline? true})), :hash \"5dt6DiPBjaZbeXfXmhPfzC4UAAhKDu\"}}] [:<> \", \"] [:strong [:<> \"the conditional probability of remainder of the\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"string given the target state \"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value \"p(x_{(s+1):t} \\\\mid z_s)\", :nextjournal/viewer {:name :nextjournal.markdown/formula, :render-fn #viewer-fn (fn [tex] (nextjournal.clerk.render/render-katex tex {:inline? true})), :hash \"5dt6DiPBjaZbeXfXmhPfzC4UAAhKDu\"}}]] [:<> \". This quantity is\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"known as the \"] [:em [:<> \"backwards probability\"]] [:<> \" in the theory of HMMs, and since it\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"involves a sum over all possible state sequences over the suffix of our\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"string, it can be costly to compute.\"]] [:p [:<> \"By writing our posterior using this decomposition, we have written it a a\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"series of single-random-variable conditional distribution, which can be\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"sampled in sequence. By sampling each \"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value \"z_s\", :nextjournal/viewer {:name :nextjournal.markdown/formula, :render-fn #viewer-fn (fn [tex] (nextjournal.clerk.render/render-katex tex {:inline? true})), :hash \"5dt6DiPBjaZbeXfXmhPfzC4UAAhKDu\"}}] [:<> \" in this sequence in turn, we can\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"draw a single sample from our posterior \"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value \"p(z_{1:t} \\\\mid x_{1:t})\", :nextjournal/viewer {:name :nextjournal.markdown/formula, :render-fn #viewer-fn (fn [tex] (nextjournal.clerk.render/render-katex tex {:inline? true})), :hash \"5dt6DiPBjaZbeXfXmhPfzC4UAAhKDu\"}}] [:<> \". However,\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"we saw the conditionals over \"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value \"z_s\", :nextjournal/viewer {:name :nextjournal.markdown/formula, :render-fn #viewer-fn (fn [tex] (nextjournal.clerk.render/render-katex tex {:inline? true})), :hash \"5dt6DiPBjaZbeXfXmhPfzC4UAAhKDu\"}}] [:<> \" are costly to compute and to some extent\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"this defeats the whole idea of the approach. We will need to take another\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"approach.\"]] [\"h1\" {:id \"locally-optimal-sequential-sampling\"} [:<> \"Locally Optimal Sequential Sampling\"]] [:p [:<> \"We saw that the sequntial decomposition of our posterior using the chain rule\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"led to a series of local distributions,\"]] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value \"p(z_s \\\\mid z_{s-1}, x_{s:t}) = \\\\frac{p(z_s \\\\mid z_{s-1})p(x_s \\\\mid z_{s})p(x_{(s+1):t} \\\\mid z_s)}\\n         { \\\\sum_{z^\\\\prime_s} p(z^\\\\prime_s \\\\mid z_{s-1})p(x_s \\\\mid z^\\\\prime_{s})p(x_{(s+1):t} \\\\mid z^\\\\prime_s) },\", :nextjournal/viewer {:name :nextjournal.markdown/block-formula, :render-fn #viewer-fn nextjournal.clerk.render/render-katex, :hash \"5dtLYB93Mi3NowoYurf1Ue76yrXtDC\"}}] [:p [:<> \"which are costly to compute. This cost arose due to the fact that we must\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"compute the marginal probability of the future of our observations sequence\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"starting from our current state \"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value \"z_s\", :nextjournal/viewer {:name :nextjournal.markdown/formula, :render-fn #viewer-fn (fn [tex] (nextjournal.clerk.render/render-katex tex {:inline? true})), :hash \"5dt6DiPBjaZbeXfXmhPfzC4UAAhKDu\"}}] [:<> \", that is \"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value \"p(x_{(s+1):t} \\\\mid z_s)\", :nextjournal/viewer {:name :nextjournal.markdown/formula, :render-fn #viewer-fn (fn [tex] (nextjournal.clerk.render/render-katex tex {:inline? true})), :hash \"5dt6DiPBjaZbeXfXmhPfzC4UAAhKDu\"}}] [:<> \".\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"Doing this involves a sum over all possible state sequences over the suffix\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"of our observation sequence.\"]] [:p [:<> \"What can we do about this? One idea is to use a different \"] [:strong [:<> \"local\"]] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"distributions that don't need to know about the future:\"]] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value \"p(z_s \\\\mid z_{s-1}, x_{s}) = \\\\frac{p(z_s \\\\mid z_{s-1})p(x_s \\\\mid z_{s})}\\n         { \\\\sum_{z^\\\\prime_s} p(z^\\\\prime_s \\\\mid z_{s-1})p(x_s \\\\mid z^\\\\prime_{s})}.\", :nextjournal/viewer {:name :nextjournal.markdown/block-formula, :render-fn #viewer-fn nextjournal.clerk.render/render-katex, :hash \"5dtLYB93Mi3NowoYurf1Ue76yrXtDC\"}}] [:p [:<> \"These distributions are locally optimal in some sense since they make optimal\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"use of all information up to time \"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value \"s\", :nextjournal/viewer {:name :nextjournal.markdown/formula, :render-fn #viewer-fn (fn [tex] (nextjournal.clerk.render/render-katex tex {:inline? true})), :hash \"5dt6DiPBjaZbeXfXmhPfzC4UAAhKDu\"}}] [:<> \", but don't need to know the future.\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"Using such distributions, we could define the probability of our entire,\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"joint state sequence as,\"]] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value \"q(z_{1:t} | x_{1:t}) = p(z_1 \\\\mid x_1) \\\\prod_{s=2}^t p(z_s \\\\mid z_{s-1}, x_{s}).\", :nextjournal/viewer {:name :nextjournal.markdown/block-formula, :render-fn #viewer-fn nextjournal.clerk.render/render-katex, :hash \"5dtLYB93Mi3NowoYurf1Ue76yrXtDC\"}}] [:p [:<> \"Note that we did not write \"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value \"p(z_{1:t} | x_{1:t})\", :nextjournal/viewer {:name :nextjournal.markdown/formula, :render-fn #viewer-fn (fn [tex] (nextjournal.clerk.render/render-katex tex {:inline? true})), :hash \"5dt6DiPBjaZbeXfXmhPfzC4UAAhKDu\"}}] [:<> \", in general $q(z_{1:t} |\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"x_{1:t}) \\\\neq p(z_{1:t} | x_{1:t})$, this product of distributions does not\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"recover our true posterior, even though $p(z_s \\\\mid z_{s-1}, x_{s}) =\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"\\\\sum_{x_{(s+1):t}} p(z_s, x_{(s+1):t} \\\\mid z_{s-1}, x_{s})$ is a correct\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"maginal with respect to our joint distribution \"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value \"p\", :nextjournal/viewer {:name :nextjournal.markdown/formula, :render-fn #viewer-fn (fn [tex] (nextjournal.clerk.render/render-katex tex {:inline? true})), :hash \"5dt6DiPBjaZbeXfXmhPfzC4UAAhKDu\"}}] [:<> \".\"]] [:p [:<> \"Still, it seems like it might be a reasonable thing to do—it makes the\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"best use possible of all the information so far, and in many domains where we\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"want to use sequential sampling techniques, the data themselves arrive one at\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"a time and thus, we \"] [:em [:<> \"cannot\"]] [:<> \" know the future. In that case, this is indeed\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"the best we could do.\"]] [:p [:<> \"Is there a way to make use of such a distribution in a way that that\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"ultimately will draw correct samples from \"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value \"p(z_{1:t} | x_{1:t})\", :nextjournal/viewer {:name :nextjournal.markdown/formula, :render-fn #viewer-fn (fn [tex] (nextjournal.clerk.render/render-katex tex {:inline? true})), :hash \"5dt6DiPBjaZbeXfXmhPfzC4UAAhKDu\"}}] [:<> \"?\"]] [\"h1\" {:id \"sequential-importance-sampling\"} [:<> \"Sequential Importance Sampling\"]] [:p [:<> \"In the last sections, we discussed how samples from a posterior distribution\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"could be sequentialized using the chain rule, allowing us to draw joint\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"samples from a sequence of conditional distribution $p(z_s \\\\mid z_{s-1},\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"x_{s:t})$. We also noted that computing this sequence of distributions is\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"costly, since it inolves summing out all future paths over states that\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"generate the suffix of our observation sequence. We introduced the notion of\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"a \"] [:em [:<> \"locally optimal\"]] [:<> \" sequence of distributions, which makes optimal use of\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"information, ignoring the future.\"]] [:p [:<> \"How can we make the use of such a locally optimal distribution?\"]] [:p [:<> \"Of course, we adopt the approach we have throughout the course: We assume\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"some proposal distribution \"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value \"q\", :nextjournal/viewer {:name :nextjournal.markdown/formula, :render-fn #viewer-fn (fn [tex] (nextjournal.clerk.render/render-katex tex {:inline? true})), :hash \"5dt6DiPBjaZbeXfXmhPfzC4UAAhKDu\"}}] [:<> \" and we correct it to the true distribution. In\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"the case of particle filtering, we adopt a sequentialized version of\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"importance sampling.\"]] [:p [:<> \"Suppose we wished to draw importance samples from our target posterior\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value \"p(z_{1:t}, x_{1:t})\", :nextjournal/viewer {:name :nextjournal.markdown/formula, :render-fn #viewer-fn (fn [tex] (nextjournal.clerk.render/render-katex tex {:inline? true})), :hash \"5dt6DiPBjaZbeXfXmhPfzC4UAAhKDu\"}}] [:<> \", from some proposal distribution $q(z_{1:t} \\\\mid\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"x_{1:t})$ if we did this each sample would be weighted using the following\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"weight by standard importance sampling:\"]] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value \"w_{1:t} = \\\\frac{p(z_{1:t}, x_{1:t})}{q(z_{1:t} \\\\mid x_{1:t})}\", :nextjournal/viewer {:name :nextjournal.markdown/block-formula, :render-fn #viewer-fn nextjournal.clerk.render/render-katex, :hash \"5dtLYB93Mi3NowoYurf1Ue76yrXtDC\"}}] [:p [:<> \"Let's further assume (beyond standard importance sampling) that our proposal\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"is \"] [:em [:<> \"incremental\"]] [:<> \", that is we have an initial proposal distribution $q(z_1\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"\\\\mid x_1)$ and a sequence of proposals \"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value \"q(z_t \\\\mid z_{t-1}, x_t)\", :nextjournal/viewer {:name :nextjournal.markdown/formula, :render-fn #viewer-fn (fn [tex] (nextjournal.clerk.render/render-katex tex {:inline? true})), :hash \"5dt6DiPBjaZbeXfXmhPfzC4UAAhKDu\"}}] [:<> \" w such that\"]] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value \"q(z_{1:t} \\\\mid x_{1:t}) = q(z_1 \\\\mid x_1) \\\\prod_{s=2}^t q(z_s \\\\mid z_{s-1}, x_s)\", :nextjournal/viewer {:name :nextjournal.markdown/block-formula, :render-fn #viewer-fn nextjournal.clerk.render/render-katex, :hash \"5dtLYB93Mi3NowoYurf1Ue76yrXtDC\"}}] [:p [:<> \"With this sequentialized proposal distribution, our weight calculations can\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"also be sequentialized.\"]] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value \"\\\\begin{align}\\n w_{1:t} &= \\\\frac{p(z_{1:t}, x_{1:t})}{q(z_{1:t} \\\\mid x_{1:t})}\\\\\\\\\\n w_{1:t} &= \\\\frac{p(z_{1:{t-1}}, x_{1:t-1})p(z_t \\\\mid z_{t-1})p(x_t \\\\mid z_t)}{q(z_{1:t} \\\\mid x_{1:t})}\\\\\\\\\\n w_{1:t} &= \\\\frac{p(z_{1:{t-1}}, x_{1:t-1})p(z_t \\\\mid z_{t-1})p(x_t \\\\mid z_t)}{q(z_{1:t-1} \\\\mid x_{1:t-1})q(z_t \\\\mid z_{t-1}, x_t)}\\\\\\\\\\n w_{1:t} &= \\\\frac{p(z_{1:{t-1}}, x_{1:t-1})}{q(z_{1:t-1} \\\\mid x_{1:t-1})}\\\\frac{p(z_t \\\\mid z_{t-1})p(x_t \\\\mid z_t)}{q(z_t \\\\mid z_{t-1}, x_t)}\\\\\\\\\\n w_{1:t} &= w_{1:t-1}\\\\frac{p(z_t \\\\mid z_{t-1})p(x_t \\\\mid z_t)}{q(z_t \\\\mid z_{t-1}, x_t)}\\\\\\\\\\n \\\\end{align}\\n \", :nextjournal/viewer {:name :nextjournal.markdown/block-formula, :render-fn #viewer-fn nextjournal.clerk.render/render-katex, :hash \"5dtLYB93Mi3NowoYurf1Ue76yrXtDC\"}}] [:p [:<> \"We can now keep an updated set of hypotheses at each time step, called\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:em [:<> \"particles\"]] [:<> \" by sequentially sampling extensions to the hypotheses at the last\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"time step using \"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value \"q(z_t \\\\mid z_{t-1}, x_t)\", :nextjournal/viewer {:name :nextjournal.markdown/formula, :render-fn #viewer-fn (fn [tex] (nextjournal.clerk.render/render-katex tex {:inline? true})), :hash \"5dt6DiPBjaZbeXfXmhPfzC4UAAhKDu\"}}] [:<> \" and udating the weight of each\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"particle by multiplying by\"]] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value \"\\\\frac{p(z_t \\\\mid z_{t-1})p(x_t \\\\mid z_t)}{q(z_t \\\\mid z_{t-1}, x_t)}\", :nextjournal/viewer {:name :nextjournal.markdown/block-formula, :render-fn #viewer-fn nextjournal.clerk.render/render-katex, :hash \"5dtLYB93Mi3NowoYurf1Ue76yrXtDC\"}}] [:p [:<> \"Sequential important sampling gives us a way to use an incremental proposal\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"distribution to update a hypothesis as we see more data points. It forms the\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"core of the algorithm we conser next: \"] [:em [:<> \"particle filtering\"]] [:<> \".\"]] [\"h1\" {:id \"particle-filters\"} [:<> \"Particle Filters\"]] [:p [:em [:<> \"Particle filters\"]] [:<> \" are a widely-used variant of SMC where we represent an\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"*approximation to our posterior distribution \"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value \"p(z_{1:1} | x_{1:t})\", :nextjournal/viewer {:name :nextjournal.markdown/formula, :render-fn #viewer-fn (fn [tex] (nextjournal.clerk.render/render-katex tex {:inline? true})), :hash \"5dt6DiPBjaZbeXfXmhPfzC4UAAhKDu\"}}] [:<> \" as a set\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"*of samples of trajectories up to that time step, where each sampled\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"*trajectory is called a \"] [:em [:<> \"particle\"]] [:<> \".\"]] [:p [:<> \"In the setting of Gen, a particle just corresponds to a trace containing a\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"sampled state up to time step \"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value \"t\", :nextjournal/viewer {:name :nextjournal.markdown/formula, :render-fn #viewer-fn (fn [tex] (nextjournal.clerk.render/render-katex tex {:inline? true})), :hash \"5dt6DiPBjaZbeXfXmhPfzC4UAAhKDu\"}}] [:<> \".\"]] [:p [:<> \"We implement a particle filter using the functions\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:code [:<> \"initialize_particle_filter\"]] [:<> \" and \"] [:code [:<> \"particle_filter_step!\"]] [:<> \" (note that this\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"implementation uses the \"] [:em [:<> \"standard proposal distribution\"]] [:<> \", which we discuss in\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"more detail below).\"]] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:div.code-viewer.code-listing [#viewer-eval nextjournal.clerk.render/inspect-presented {:path [0], :nextjournal/value \"init_obs = Gen.choicemap((:x => 1, ground_truth[:x => 1]))\\n\\nn_particles = 20\\nstate = Gen.initialize_particle_filter(\\n    hmm,\\n    (1, ϕ, transition, observation),\\n    init_obs,\\n    n_particles)\\n\\n;;=\\n(log_incremental_weights,) = particle_filter_step!(\\n    state::ParticleFilterState,\\n    new_args::Tuple,\\n    argdiffs,\\n    observations::ChoiceMap,\\n    proposal::GenerativeFunction,\\n    proposal_args::Tuple)\\n=;;\\n\\nfor t=2:T\\n    obs = Gen.choicemap((:x => t, ground_truth[:x => t]))\\n    Gen.particle_filter_step!(\\n        state,\\n        (t, ϕ, transition, observation),\\n        (UnknownChange(),),\\n        obs)\\nend;\\nstate\", :nextjournal/render-opts {:language \"julia\"}, :nextjournal/viewer {:name nextjournal.clerk.viewer/code-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-code, :hash \"5dsJQw12yyyd7TcZEf52VSHxnqnJUC\"}}]], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:p [:<> \"State objects contain three pieces of information:\"]] [:ol [:li [:<> [:<> \"A vector of traces for each particle at the current time step.\"]]] [:li [:<> [:<> \"A vector of weights for each particle at the current time step.\"]]] [:li [:<> [:<> \"An average (log) weight (more on this later).\"]]]] [:p [:<> \"Let's implement a function which runs our particle filter.\"]] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:div.code-viewer.code-listing [#viewer-eval nextjournal.clerk.render/inspect-presented {:path [0], :nextjournal/value \"function hmm_particle_filter(\\n        ground_truth::Gen.DynamicDSLTrace,\\n        n_particles::Int64;\\n        resampling=false)\\n\\n    init_obs = Gen.choicemap((:x => 1, ground_truth[:x => 1]))\\n\\n    state = Gen.initialize_particle_filter(\\n        hmm,\\n        (1, ϕ, transition, observation),\\n        init_obs,\\n        n_particles)\\n\\n    all_particle_weights=reshape(ones(n_particles),(1,:))\\n    all_lmls=[]\\n\\n    for t=2:T\\n        if resampling\\n            Gen.maybe_resample!(state, ess_threshold=n_particles/2)\\n        end\\n\\n        obs = Gen.choicemap((:x => t, ground_truth[:x => t]))\\n\\n        Gen.particle_filter_step!(\\n            state,\\n            (t, ϕ, transition, observation),\\n            (UnknownChange(),),\\n            obs)\\n\\n        all_particle_weights=vcat(\\n            copy(all_particle_weights),\\n            reshape(copy(state.log_weights), (1,:)))\\n\\n        push!(all_lmls, copy(state.log_ml_est))\\n    end\\n\\n    return(state, all_particle_weights, all_lmls)\\nend;\", :nextjournal/render-opts {:language \"julia\"}, :nextjournal/viewer {:name nextjournal.clerk.viewer/code-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-code, :hash \"5dsJQw12yyyd7TcZEf52VSHxnqnJUC\"}}]], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:p [:<> \"It will be useful to plot the outputs of our particle filters.\"]] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:div.code-viewer.code-listing [#viewer-eval nextjournal.clerk.render/inspect-presented {:path [0], :nextjournal/value \"function logsumexp(a; dims=:)\\n    m = maximum(a, dims=dims) # pull out max for stability\\n    m .+ log.(sum(exp.(a .- m), dims=dims))\\nend;\\nnormalize_weights(W) = W .- logsumexp(W; dims=2);\\n\\nfunction plot_particle_filter(\\n        T, state, all_particle_weights,\\n        all_lmls;\\n        backend=plotly())\\n\\n    backend;\\n    n_particles=length(state.log_weights)\\n    normalized_weights = normalize_weights(all_particle_weights[1:T,:]);\\n    labels=reshape([\\\"Particle $j\\\" for j in 1:n_particles],(1,:))\\n    observation_markerstyle=(:circle, 4, 0.7, stroke(1, .5, :gray))\\n    state_markerstyle=(:square, 4, 0.7, stroke(1, .5, :gray))\\n\\n    # Get observations\\n    observations = [[get_choices(state.traces[j])[:x=>i] for i in 1:T] for j in 1:n_particles]\\n    observations_plot = scatter(observations, title=\\\"Observations\\\", ylabel=\\\"value\\\", #xlabel=\\\"t\\\",\\n        yminorgrid=true, yminorticks=2, ygridalpha=.3, minorgridalpha=.2,\\n        marker=observation_markerstyle, alpha=.4)\\n\\n    # Get all the particles paths through the trellis.\\n    paths = [[get_choices(state.traces[j])[:z=>i] for i in 1:T] for j in 1:n_particles]\\n    paths_plot = plot(paths, title=\\\"Particles' paths\\\", ylabel=\\\"hidden state\\\", #xlabel=\\\"t\\\",\\n        yminorgrid=true, yminorticks=2, #ygridalpha=.3, minorgridalpha=.2,\\n        marker=state_markerstyle, lw=3, alpha=.4)\\n\\n    # And weights\\n    unnormalized_weights_plot = plot(all_particle_weights[1:T,:],\\n        title=\\\"Particles' weights (at time t)\\\", ylabel=\\\"log weight\\\", #xlabel=\\\"t\\\",\\n        ticks=:native, lw=4, alpha=.5)\\n\\n    weights_plot_log = plot(normalized_weights[1:T,:],\\n        title=\\\"Particles' log normalized weights (at time t)\\\", ylabel=\\\"log weight\\\", #xlabel=\\\"t\\\",\\n        ticks=:native, lw=4, alpha=.5)\\n\\n    weights_plot = plot(exp.(normalized_weights)[1:T,:],\\n        title=\\\"Particles' normalized weights (at time t)\\\", ylabel=\\\"weight\\\", xlabel=\\\"t\\\",\\n        ticks=:native, lw=4, alpha=.5)\\n\\n    plot(observations_plot,paths_plot,unnormalized_weights_plot,weights_plot,weights_plot_log,\\n        xlims=(0,T+1), layout=(5,1), size=(1000,600), legend = false, label=labels)\\nend;\\n\\nfunction make_plot_animation(\\n        T,\\n        ground_truth,\\n        n_particles;\\n        initialization=nothing,\\n        proposal=nothing,\\n        resampling=true,\\n        rejuvenation=true,\\n        rejuv_proposal=nothing,\\n        rejuv_proposal_args=nothing,\\n        fps = 10)\\n\\n    init_obs = Gen.choicemap((:x => 1, ground_truth[:x => 1]))\\n\\n    state = if initialization==nothing\\n      Gen.initialize_particle_filter(\\n        hmm,\\n        (1, ϕ, transition, observation),\\n        init_obs,\\n        n_particles)\\n    else\\n        Gen.initialize_particle_filter(\\n            hmm,\\n            (1, ϕ, transition, observation),\\n            init_obs,\\n            initialization,\\n            (ϕ, observation, ground_truth[:x => 1],),\\n            n_particles)\\n    end\\n\\n    all_particle_weights=reshape(ones(n_particles),(1,:))\\n    all_lmls=[]\\n\\n    anim = @animate for t=2:T\\n\\n\\n        if resampling\\n            Gen.maybe_resample!(state, ess_threshold=n_particles/2)\\n        end\\n\\n        obs = Gen.choicemap(\\n            (:x => t, ground_truth[:x => t]))\\n\\n        if proposal==nothing\\n            Gen.particle_filter_step!(\\n                state,\\n                (t, ϕ, transition, observation),\\n                (UnknownChange(),),\\n                obs)\\n        else\\n            Gen.particle_filter_step!(\\n                state,\\n                (t, ϕ, transition, observation),\\n                (UnknownChange(),),\\n                obs,\\n                proposal,\\n                (ground_truth[:x => t],))\\n        end\\n\\n        if rejuvenation\\n            for i=1:n_particles\\n                choices = select([:z => i for i in 1:T]...)\\n                if rejuv_proposal==nothing\\n                    state.traces[i], _  = mh(state.traces[i], choices)\\n                else\\n                    state.traces[i], _  = mh(state.traces[i], rejuv_proposal, rejuv_proposal_args)\\n                end\\n            end\\n        end\\n\\n        all_particle_weights=vcat(\\n            copy(all_particle_weights),\\n            reshape(copy(state.log_weights), (1,:)))\\n\\n        push!(all_lmls, copy(state.log_ml_est))\\n\\n        plot_particle_filter(\\n            t, state, all_particle_weights, all_lmls;\\n            backend=gr())\\n    end\\n\\n    gif(anim, fps = fps)\\nend;\", :nextjournal/render-opts {:language \"julia\"}, :nextjournal/viewer {:name nextjournal.clerk.viewer/code-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-code, :hash \"5dsJQw12yyyd7TcZEf52VSHxnqnJUC\"}}]], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:p [:<> \"We will condition on the observations contained in our sampled \"] [:em [:<> \"ground truth\"]] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"trace.\"]] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:div.code-viewer.code-listing [#viewer-eval nextjournal.clerk.render/inspect-presented {:path [0], :nextjournal/value \"get_choices(ground_truth)\\n\\nmake_plot_animation(\\n    T,\\n    ground_truth,\\n    10,\\n    resampling=false,\\n    rejuvenation=false,\\n    fps=6)\", :nextjournal/render-opts {:language \"julia\"}, :nextjournal/viewer {:name nextjournal.clerk.viewer/code-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-code, :hash \"5dsJQw12yyyd7TcZEf52VSHxnqnJUC\"}}]], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:p [:<> \"What are the bottom three plots in the figure? Our discussion of particle\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"filtering so far has left out an important aspect of the approach: the use of\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"arbitrary proposal distributions. Before discussing the behavior of these\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"algorithms more generally, we introduce the proposal distribution we are\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"using.\"]] [:p [:<> \"First, we did not specify above, but our implementation of the HMM particle\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"filter here is using the \"] [:em [:<> \"standard proposal\"]] [:<> \" which is just the prior\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"distribution, \"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value \"q(z_t \\\\mid z_{t-1}, x_{t})=p(z_t \\\\mid z_{t-1})\", :nextjournal/viewer {:name :nextjournal.markdown/formula, :render-fn #viewer-fn (fn [tex] (nextjournal.clerk.render/render-katex tex {:inline? true})), :hash \"5dt6DiPBjaZbeXfXmhPfzC4UAAhKDu\"}}] [:<> \".\"]] [:p [:<> \"Similar to the way that the \"] [:code [:<> \"generate\"]] [:<> \" function worked, this gives rise to an\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"incremenetal form of \"] [:em [:<> \"likelihood weighting\"]] [:<> \". Our incremental weights are\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"given by\"]] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value \"\\\\begin{align}\\n w_t &= \\\\frac{p(z_t\\\\mid z_{t-1})p(x_t \\\\mid z_t)}{q(z_t \\\\mid z_{t-1}, x_{t})}\\\\\\\\\\n w_t &= \\\\frac{p(z_t\\\\mid z_{t-1})p(x_t \\\\mid z_t)}{p(z_t\\\\mid z_{t-1})}\\\\\\\\\\n w_t &= p(x_t \\\\mid z_t)\\n \\\\end{align}\", :nextjournal/viewer {:name :nextjournal.markdown/block-formula, :render-fn #viewer-fn nextjournal.clerk.render/render-katex, :hash \"5dtLYB93Mi3NowoYurf1Ue76yrXtDC\"}}] [:p [:<> \"Thus the total weight up to time point \"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value \"t\", :nextjournal/viewer {:name :nextjournal.markdown/formula, :render-fn #viewer-fn (fn [tex] (nextjournal.clerk.render/render-katex tex {:inline? true})), :hash \"5dt6DiPBjaZbeXfXmhPfzC4UAAhKDu\"}}] [:<> \" is just the likelihood of the\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"observations under the path of the states.\"]] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value \"w_{1:t} =  \\\\prod_{s=1}^{t} p(x_{s} \\\\mid z_s)\", :nextjournal/viewer {:name :nextjournal.markdown/block-formula, :render-fn #viewer-fn nextjournal.clerk.render/render-katex, :hash \"5dtLYB93Mi3NowoYurf1Ue76yrXtDC\"}}] [:p [:<> \"Let's look at the behavior of the weights for this incremental\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"likelihood-weighted HMM particle filter.\"]] [:p [:<> \"First, examining the third panel, we notice that the weight of each particle\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"is going down over time as the overall likelihood of the sequence goes down.\"]] [:blockquote [:p [:<> \"Why is this the expected behavior?\"]]] [:p [:<> \"It is also useful to ask how the particles behave with respect to one\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"another, rather than globally. We can examine this question by looking at the\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"normalized particle weights at each time step. The fourth panel shows the\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"normalized weights, which allows us to examine the relative quality (in this\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"incremental likelihood) of each sampled state trajectory. The fith panel\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"shows the log normalized weights, which allows us to see more clearly the\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"spread of particle weights over time.\"]] [:p [:<> \"We see in the fourth plot, that the quality of particles is very peaky. In\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"particular, particles are exhibiting a switching behavior with one particle\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"at a time dominating the others in terms of its quality. Why is this?\"]] [:p [:<> \"Since the proposal distribution pays no attention to the likelihood of each\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"observation, the particles transition based just on the prior probability of\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"the transition. Our transition distributions are relatively flat, while our\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"observation distributions are sparse.\"]] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:div.code-viewer.code-listing [#viewer-eval nextjournal.clerk.render/inspect-presented {:path [0], :nextjournal/value \"round.(transition; digits=3)\\n\\nround.(observation; digits=3)\", :nextjournal/render-opts {:language \"julia\"}, :nextjournal/viewer {:name nextjournal.clerk.viewer/code-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-code, :hash \"5dsJQw12yyyd7TcZEf52VSHxnqnJUC\"}}]], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:p [:<> \"Thus, it is only a matter of time before a some particle transitions to a bad\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"state that generates the observed data with low probability. There is nothing\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"to keep the particles transitioning to good states and thus their weights\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"follow a random walk, for a while, they will accidentally transition to good\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"states, and then randomly transition to bad states. Since the observation\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"distribution is so peaky, typically one particle will dominate the rest.\"]] [:p [:<> \"How can we fix this behavior?\"]] [:p [:<> \"As a first attempt, we could use a more sensible proposal distribution. Which\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"one could we use? One obvious answer to make use of the likelihood of each\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"observed symbol in our proposals. We have already seen a proposal which does\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"this the \"] [:em [:<> \"locally optimal proposal\"]] [:<> \".\"]] [:p [:<> \"Consider the sequence of distributions:\"]] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value \"p(z_t \\\\mid z_{1:(t-1)}, x_{1:t}) = \\\\frac{p(z_t \\\\mid z_{t-1})p(x_t \\\\mid z_t)}{\\\\sum_{z_{t}} p(z_t \\\\mid z_{t-1})p(x_t \\\\mid z_t)} = p(z_t \\\\mid z_{t-1}, x_{t})\", :nextjournal/viewer {:name :nextjournal.markdown/block-formula, :render-fn #viewer-fn nextjournal.clerk.render/render-katex, :hash \"5dtLYB93Mi3NowoYurf1Ue76yrXtDC\"}}] [:p [:<> \"Note that the normalizing constant $\\\\sum_{z_{t}} p(z_t \\\\mid z_{t-1})p(x_t\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"\\\\mid z_t)$ is the conditional marginal probability of the observation,\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"conditioned on the last state, that is, \"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value \"p(x_t \\\\mid z_{t-1})\", :nextjournal/viewer {:name :nextjournal.markdown/formula, :render-fn #viewer-fn (fn [tex] (nextjournal.clerk.render/render-katex tex {:inline? true})), :hash \"5dt6DiPBjaZbeXfXmhPfzC4UAAhKDu\"}}] [:<> \".\"]] [:p [:<> \"Using \"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value \"p(z_t \\\\mid z_{t-1}, x_t)\", :nextjournal/viewer {:name :nextjournal.markdown/formula, :render-fn #viewer-fn (fn [tex] (nextjournal.clerk.render/render-katex tex {:inline? true})), :hash \"5dt6DiPBjaZbeXfXmhPfzC4UAAhKDu\"}}] [:<> \" as \"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value \"q(z_t \\\\mid z_{t-1}, x_t)\", :nextjournal/viewer {:name :nextjournal.markdown/formula, :render-fn #viewer-fn (fn [tex] (nextjournal.clerk.render/render-katex tex {:inline? true})), :hash \"5dt6DiPBjaZbeXfXmhPfzC4UAAhKDu\"}}] [:<> \", the locally\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"optimal proposal is optimal with respect to time step \"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value \"t\", :nextjournal/viewer {:name :nextjournal.markdown/formula, :render-fn #viewer-fn (fn [tex] (nextjournal.clerk.render/render-katex tex {:inline? true})), :hash \"5dt6DiPBjaZbeXfXmhPfzC4UAAhKDu\"}}] [:<> \", that is, assuming\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"we can't see into the future.\"]] [:p [:<> \"Plugging this into our formula for weights we get\"]] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value \"w_{t} = \\\\frac{p(z_t \\\\mid z_{t-1})p(x_t \\\\mid z_t)}{\\\\frac{p(z_t \\\\mid z_{t-1})p(x_t \\\\mid z_t)}{\\\\sum_{z_{t}} p(z_t \\\\mid z_{t-1})p(x_t \\\\mid z_t)}} = \\\\sum_{z_{t}} p(z_t \\\\mid z_{t-1})p(x_t \\\\mid z_t) = p(x_t \\\\mid z_{t-1})\", :nextjournal/viewer {:name :nextjournal.markdown/block-formula, :render-fn #viewer-fn nextjournal.clerk.render/render-katex, :hash \"5dtLYB93Mi3NowoYurf1Ue76yrXtDC\"}}] [:p [:<> \"In other words, the incremental weight for the optimal proposal is just the\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"marginal probability of the observation given the last state. Thus, so long\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"as the preceding state can assign high probability to the next observation\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:strong [:<> \"using some state\"]] [:<> \" our weights will be high.\"]] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value \"w_{1:t} =  \\\\prod_{s=1}^{t} p(x_{s} \\\\mid z_{s-1})\", :nextjournal/viewer {:name :nextjournal.markdown/block-formula, :render-fn #viewer-fn nextjournal.clerk.render/render-katex, :hash \"5dtLYB93Mi3NowoYurf1Ue76yrXtDC\"}}] [:p [:<> \"To implement this, we use versions of\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:code [:<> \"initialize_particle_filter\"]] [:<> \" and \"] [:code [:<> \"particle_filter_step!\"]] [:<> \" which take generative functions implementing the initial and incremental proposals.\"]] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:div.code-viewer.code-listing [#viewer-eval nextjournal.clerk.render/inspect-presented {:path [0], :nextjournal/value \"function normalize(a)\\n    a ./ sum(a)\\nend;\\n\\n@gen function optimal_proposal_init(ϕ, observation, next_obs::Int)\\n    ws = Vector{Float64}(undef, length(ϕ))\\n    for (i, val) in enumerate(ϕ)\\n        ws[i]=ϕ[i]*observation[i,next_obs]\\n    end\\n\\n    weights=normalize(ws)\\n    ({:z => 1} ~ categorical(weights))\\nend\\n\\n@gen function optimal_proposal(old_particle::Gen.DynamicDSLTrace, next_obs::Int)\\n    T, ϕ, transition, observation = get_args(old_particle)\\n\\n    transitions=transition[old_particle[:z => T],:]\\n\\n    ws = Vector{Float64}(undef, length(transitions))\\n    for (i, val) in enumerate(transitions)\\n        ws[i]=transitions[i]*observation[i,next_obs]\\n    end\\n\\n    weights=normalize(ws)\\n    ({:z => T+1} ~ categorical(weights))\\nend;\", :nextjournal/render-opts {:language \"julia\"}, :nextjournal/viewer {:name nextjournal.clerk.viewer/code-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-code, :hash \"5dsJQw12yyyd7TcZEf52VSHxnqnJUC\"}}]], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:p [:<> \"Let's look at the behavior of this particle filter over time.\"]] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:div.code-viewer.code-listing [#viewer-eval nextjournal.clerk.render/inspect-presented {:path [0], :nextjournal/value \"make_plot_animation(\\n    T,\\n    ground_truth,\\n    10,\\n    initialization=optimal_proposal_init,\\n    proposal=optimal_proposal,\\n    resampling=false,\\n    rejuvenation=false,\\n    fps=6)\", :nextjournal/render-opts {:language \"julia\"}, :nextjournal/viewer {:name nextjournal.clerk.viewer/code-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-code, :hash \"5dsJQw12yyyd7TcZEf52VSHxnqnJUC\"}}]], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:p [:<> \"We can see now that all four particles are staying relatively probable\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"throughout. This is because our transition distribution is relatively flat\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"which allows our locally optimal proposal to choose transitions to good\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"states that assign high probability to the next observation What would happen\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"though if our transition distribution were also sparse.\"]] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:div.code-viewer.code-listing [#viewer-eval nextjournal.clerk.render/inspect-presented {:path [0], :nextjournal/value \"α = fill(0.01,K)\\n\\ntransition = zeros(K,K)\\nfor k in 1:K\\n    transition[k,:] = rand(Dirichlet(α))\\nend;\", :nextjournal/render-opts {:language \"julia\"}, :nextjournal/viewer {:name nextjournal.clerk.viewer/code-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-code, :hash \"5dsJQw12yyyd7TcZEf52VSHxnqnJUC\"}}]], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:div.code-viewer.code-listing [#viewer-eval nextjournal.clerk.render/inspect-presented {:path [0], :nextjournal/value \"make_plot_animation(\\n    T,\\n    ground_truth,\\n    10,\\n    initialization=optimal_proposal_init,\\n    proposal=optimal_proposal,\\n    resampling=false,\\n    rejuvenation=false,\\n    fps=6)\", :nextjournal/render-opts {:language \"julia\"}, :nextjournal/viewer {:name nextjournal.clerk.viewer/code-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-code, :hash \"5dsJQw12yyyd7TcZEf52VSHxnqnJUC\"}}]], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:p [:<> \"We see a return to our original bad behavior. The optimal proposal cannot\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"make good transitions from bad preceding states in this case, and our\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"particles get \\\"stuck\\\" in poor trajectories. How can we design an algorithm to\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"do better than this.\"]] [\"h1\" {:id \"the-bootstrap-filter\"} [:<> \"The Bootstrap Filter\"]] [:p [:<> \"One approach to eliminating bad trajectories is the \"] [:em [:<> \"bootstrap fiter\"]] [:<> \". With\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"the bootstrap filter we simply add an importance resampling step whenever the\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"set of particles becomes too skewed. One way of doing this is to use the\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:em [:<> \"effective sample size\"]] [:<> \" ESS.\"]] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value \"\\\\mathrm{ESS} = \\\\frac{1}{\\\\sum_{p} \\\\hat{w}_p^2}\", :nextjournal/viewer {:name :nextjournal.markdown/block-formula, :render-fn #viewer-fn nextjournal.clerk.render/render-katex, :hash \"5dtLYB93Mi3NowoYurf1Ue76yrXtDC\"}}] [:p [:<> \"Where \"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value \"p\", :nextjournal/viewer {:name :nextjournal.markdown/formula, :render-fn #viewer-fn (fn [tex] (nextjournal.clerk.render/render-katex tex {:inline? true})), :hash \"5dt6DiPBjaZbeXfXmhPfzC4UAAhKDu\"}}] [:<> \" ranges over particles and \"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value \"\\\\hat{w}_p\", :nextjournal/viewer {:name :nextjournal.markdown/formula, :render-fn #viewer-fn (fn [tex] (nextjournal.clerk.render/render-katex tex {:inline? true})), :hash \"5dt6DiPBjaZbeXfXmhPfzC4UAAhKDu\"}}] [:<> \" is the normalized importance\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"weight of particle \"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value \"p\", :nextjournal/viewer {:name :nextjournal.markdown/formula, :render-fn #viewer-fn (fn [tex] (nextjournal.clerk.render/render-katex tex {:inline? true})), :hash \"5dt6DiPBjaZbeXfXmhPfzC4UAAhKDu\"}}] [:<> \". A typical criterion is to insert an importance\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"resampling step each time the ESS drops below the number of particles divided\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"by \"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value \"2\", :nextjournal/viewer {:name :nextjournal.markdown/formula, :render-fn #viewer-fn (fn [tex] (nextjournal.clerk.render/render-katex tex {:inline? true})), :hash \"5dt6DiPBjaZbeXfXmhPfzC4UAAhKDu\"}}] [:<> \".\"]] [:p [:<> \"Gen provides the \"] [:code [:<> \"maybe_resample!\"]] [:<> \" function to implement this bootstrapping step.\"]] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:div.code-viewer.code-listing [#viewer-eval nextjournal.clerk.render/inspect-presented {:path [0], :nextjournal/value \"make_plot_animation(\\n    T,\\n    ground_truth,\\n    10,\\n    initialization=optimal_proposal_init,\\n    proposal=optimal_proposal,\\n    resampling=true,\\n    rejuvenation=false,\\n    fps=6)\", :nextjournal/render-opts {:language \"julia\"}, :nextjournal/viewer {:name nextjournal.clerk.viewer/code-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-code, :hash \"5dsJQw12yyyd7TcZEf52VSHxnqnJUC\"}}]], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:p [:<> \"We can see here that now the particles are staying almost perfectly\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"equiprobable thanks to the resampling steps.\"]] [\"h1\" {:id \"rejuvenation\"} [:<> \"Rejuvenation\"]] [:p [:<> \"The bootstrap filter improved the performance of our particle filter by\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"ensuring that extremely bad particles were \\\"weeded out\\\" and replaced by\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"particles which had a better trace. However, we now see an additional\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"problem—there is very little diversity in the hypothesized latent\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}] [:<> \"variables in our particle states.\"]] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:div.code-viewer.code-listing [#viewer-eval nextjournal.clerk.render/inspect-presented {:path [0], :nextjournal/value \"make_plot_animation(\\n    T,\\n    ground_truth,\\n    10,\\n    initialization=optimal_proposal_init,\\n    proposal=optimal_proposal,\\n    resampling=true,\\n    rejuvenation=true,\\n    fps=6)\\n\\n@gen function gibbs_proposal(trace, addr_prefix)\\n    T, ϕ, transition, observation = get_args(trace)\\n    K=size(transition)[1]\\n\\n    # Update each latent variable in turn\\n    for i=1:T\\n\\n        address = addr_prefix => i\\n\\n        lps = Vector{Float64}(undef, K)\\n        for j in 1:K\\n            obs = Gen.choicemap()\\n            obs[address] = j\\n            (t, _) = Gen.update(trace, obs)\\n            lps[j]=get_score(t)\\n\\n        end\\n\\n        m = maximum(lps)\\n        lse = m .+ log.(sum(exp.(lps .- m)))\\n        probs=exp.(lps .- lse)\\n        ps = normalize(round.(probs, digits = 3))\\n\\n        {address} ~ categorical(ps)\\n    end\\nend\\n\\n\\nmake_plot_animation(\\n    T,\\n    ground_truth,\\n    10, #num particles\\n    initialization=optimal_proposal_init,\\n    proposal=optimal_proposal,\\n    resampling=true,\\n    rejuvenation=true,\\n    rejuv_proposal=gibbs_proposal,\\n    rejuv_proposal_args=(:z,),\\n    fps=6)\", :nextjournal/render-opts {:language \"julia\"}, :nextjournal/viewer {:name nextjournal.clerk.viewer/code-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-code, :hash \"5dsJQw12yyyd7TcZEf52VSHxnqnJUC\"}}]], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-html, :hash \"5drpr3yzJ1CcHNbRHnK2sVyn7YUmXB\"}}]], :nextjournal/render-opts {:id \"user/markdown-5dtpsQfikDADatdBt6QzAGCpBctowm\"}, :nextjournal/viewer {:name nextjournal.clerk.viewer/markdown-node-viewer, :render-fn #viewer-fn identity, :hash \"5dsg4Bx9A9L7WvvCgamUoRtxUsmYCe\"}}]}, :nextjournal/viewer {:name nextjournal.clerk.viewer/notebook-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-notebook, :hash \"5duAFDxE4sCnRX71Wo6zeCpC9C3djE\"}}}, :path->url {\"notebooks/lectures/genlite.clj\" \"notebooks/lectures/genlite.html\", \"notebooks/lectures/smc.clj\" \"notebooks/lectures/smc.html\", \"notebooks/lectures/importance.clj\" \"notebooks/lectures/importance.html\", \"notebooks/lectures/inference.clj\" \"notebooks/lectures/inference.html\", \"notebooks/lectures/simulation.clj\" \"notebooks/lectures/simulation.html\", \"notebooks/lectures/mcmc.clj\" \"notebooks/lectures/mcmc.html\", \"notebooks/lectures/face.clj\" \"notebooks/lectures/face.html\", \"file:/Users/sritchie/.gitlibs/libs/io.github.nextjournal/clerk/d80187013d7b7b96db3d8b114b8d99f687170668/src/nextjournal/clerk/index.clj\" \"\"}, :current-path \"notebooks/lectures/smc.clj\", :resource->url {\"/js/viewer.js\" \"https://cas.clerk.garden/tree/8VxCcd2nQqrhPLVttyyM5Rnv8qMYcjeSEjgJnhZTvCgVhmgsNWWeusxmVkfX9ajrXmFqQEdVmtdHSoCdHLG2XTsXXB/.clerk/shadow-cljs/main.js\"}, :index \"file:/Users/sritchie/.gitlibs/libs/io.github.nextjournal/clerk/d80187013d7b7b96db3d8b114b8d99f687170668/src/nextjournal/clerk/index.clj\"}".replaceAll('nextjournal.clerk.view/escape-closing-script-tag', 'script')
viewer.init(viewer.read_string(state))
</script></body></html>